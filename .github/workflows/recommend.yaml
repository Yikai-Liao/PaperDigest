name: Paper Recommendation Pipeline

on:
  workflow_dispatch:
    inputs:
      matrix_count:
        description: 'å¹¶è¡Œå¤„ç†ä»»åŠ¡æ•°é‡'
        required: true
        default: 4
        type: number
  schedule:
    # ä¸œå…«åŒº(UTC+8)æ—©8ç‚¹ = UTC 0ç‚¹
    - cron: '30 1 * * *'

jobs:
  prepare_data:
    name: é¢„æµ‹å¹¶ä¸‹è½½ PDF æ–‡ä»¶
    runs-on: ubuntu-latest
    outputs:
      batch_list: ${{ steps.split_dirs.outputs.batch_list }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: å®‰è£…ä¾èµ–
        run: |
          uv sync

      - name: Hugging Face ç™»å½•
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          uv run huggingface-cli login --token $HUGGINGFACE_TOKEN

      - name: è¿è¡Œé¢„æµ‹æ¨¡å‹
        run: uv run python script/fit_predict.py

      - name: ä¸Šä¼ é¢„æµ‹ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: predictions
          path: data/predictions.parquet
        
      - name: ä¸‹è½½ PDF æ–‡ä»¶
        run: uv run python script/download_pdf.py

      - name: æ‹†åˆ† PDF ç›®å½•
        id: split_dirs
        run: |
          # åˆ›å»ºä»»åŠ¡åˆ†å‰²ç›®å½•
          mkdir -p pdf_batches
          
          # è·å–æ€» PDF æ–‡ä»¶æ•°
          total_files=$(find pdfs -name "*.pdf" | wc -l)
          
          # å¤„ç† matrix_countï¼Œç¡®ä¿ä¸ºæ•´æ•°
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            input_matrix_count=${{ github.event.inputs.matrix_count }}
          else
            input_matrix_count=4
          fi
          matrix_count=$(echo $input_matrix_count | awk '{print int($1)}')
          
          # ç¡®ä¿ matrix_count ä¸è¶…è¿‡æ–‡ä»¶æ€»æ•°
          if [ $matrix_count -gt $total_files ]; then
            matrix_count=$total_files
          fi
          
          echo "æ€»æ–‡ä»¶æ•°: $total_files"
          echo "ä»»åŠ¡æ•°é‡: $matrix_count"
          
          # è®¡ç®—æ¯ä¸ªæ‰¹æ¬¡åº”åŒ…å«çš„æ–‡ä»¶æ•°
          files_per_batch=$(( (total_files + matrix_count - 1) / matrix_count ))
          echo "æ¯ä¸ªä»»åŠ¡å¤„ç†æ–‡ä»¶æ•°: $files_per_batch"
          
          # åˆ›å»ºç›®å½•ç»“æ„
          for i in $(seq 1 $matrix_count); do
            mkdir -p "pdf_batches/batch_$i"
          done
          
          # å°† PDF æ–‡ä»¶åˆ†é…åˆ°ä¸åŒæ‰¹æ¬¡ç›®å½•
          counter=0
          batch_num=1
          
          # æ ¹æ®æ–‡ä»¶åæ’åºï¼Œç¡®ä¿ç›¸åŒçš„åˆ†é…
          find pdfs -name "*.pdf" | sort | while read pdf_file; do
            # å¤åˆ¶åˆ°ç›¸åº”æ‰¹æ¬¡ç›®å½•
            cp "$pdf_file" "pdf_batches/batch_$batch_num/"
            
            counter=$((counter + 1))
            if [ $counter -ge $files_per_batch ] && [ $batch_num -lt $matrix_count ]; then
              counter=0
              batch_num=$((batch_num + 1))
            fi
          done
          
          # ç»Ÿè®¡æ¯ä¸ªæ‰¹æ¬¡åŒ…å«çš„æ–‡ä»¶æ•°
          echo "æ‰¹æ¬¡åˆ†é…æƒ…å†µ:"
          total_batches=0
          for i in $(seq 1 $matrix_count); do
            file_count=$(find "pdf_batches/batch_$i" -name "*.pdf" | wc -l)
            echo "batch_$i: $file_count ä¸ªæ–‡ä»¶"
            if [ $file_count -gt 0 ]; then
              total_batches=$((total_batches + 1))
            fi
          done
          
          # ç”Ÿæˆæ‰¹æ¬¡åˆ—è¡¨ä¾›åç»­ matrix ä½¿ç”¨
          seq 1 $total_batches | sed 's/^/batch_/' > pdf_batches/batch_list.txt
          batch_list=$(cat pdf_batches/batch_list.txt | tr '\n' ',' | sed 's/,$//')
          echo "batch_list=$batch_list" >> $GITHUB_OUTPUT

          # åˆ›å»º JSON æ ¼å¼çš„æ•°ç»„
          echo -n "batch_list=[" >> $GITHUB_OUTPUT
          for i in $(seq 1 $total_batches); do
            if [ $i -eq $total_batches ]; then
              echo -n "\"batch_$i\"" >> $GITHUB_OUTPUT
            else
              echo -n "\"batch_$i\"," >> $GITHUB_OUTPUT
            fi
          done
          echo "]" >> $GITHUB_OUTPUT

          # ç¡®ä¿è¾“å‡ºä¸ä¸ºç©º
          if [ $total_batches -eq 0 ]; then
            echo "batch_list=[\"batch_1\"]" >> $GITHUB_OUTPUT
          fi
          
          echo "å®é™…ä½¿ç”¨æ‰¹æ¬¡æ•°: $total_batches"

      - name: ä¸Šä¼  PDF æ‰¹æ¬¡
        uses: actions/upload-artifact@v4
        with:
          name: pdf-batches
          path: pdf_batches/
          retention-days: 1

  process_pdfs:
    name: å¤„ç† PDF æ‰¹æ¬¡ ${{ matrix.batch }}
    needs: prepare_data
    runs-on: ubuntu-latest
    strategy:
      matrix:
        batch: ${{ fromJson(needs.prepare_data.outputs.batch_list) }}
      max-parallel: 2  # é™åˆ¶å¹¶å‘æ•°ï¼Œé¿å…åŒæ—¶ä¸‹è½½æ¨¡å‹å¯¼è‡´å†²çª
      fail-fast: false

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: ä¸‹è½½ PDF æ‰¹æ¬¡
        uses: actions/download-artifact@v4
        with:
          name: pdf-batches
          path: pdf_batches

      - name: ç¼“å­˜ Hugging Face æ¨¡å‹
        uses: actions/cache@v4
        id: huggingface-cache
        with:
          path: /home/runner/.cache/huggingface
          key: ${{ runner.os }}-huggingface-marker

      - name: å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬ marker-pdfï¼‰
        run: uv sync --extra marker

      - name: é¢„çƒ­ marker æ¨¡å‹ç¼“å­˜
        run: |
          # é¢„å…ˆä¸‹è½½æ¨¡å‹ï¼Œé¿å…å¤šä¸ª worker åŒæ—¶ä¸‹è½½å¯¼è‡´å†²çª
          uv run python -c "from marker.models import load_all_models; load_all_models()" || true

      - name: å¤„ç† PDF æ–‡ä»¶
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p extracted_mds
          
          # è·å–å½“å‰æ‰¹æ¬¡
          BATCH_DIR="pdf_batches/${{ matrix.batch }}"
          echo "å¤„ç†æ‰¹æ¬¡ç›®å½•: $BATCH_DIR"
          
          # æ£€æŸ¥ç›®å½•ä¸­çš„æ–‡ä»¶æ•°é‡
          pdf_count=$(find "$BATCH_DIR" -name "*.pdf" | wc -l)
          echo "è¯¥æ‰¹æ¬¡åŒ…å« $pdf_count ä¸ª PDF æ–‡ä»¶"
          
          if [ $pdf_count -gt 0 ]; then
            # ä½¿ç”¨ marker å¤„ç†æ•´ä¸ªç›®å½•ï¼ˆå• worker é¿å…æ¨¡å‹ä¸‹è½½å†²çªï¼‰
            uv run marker "$BATCH_DIR" --disable_image_extraction --output_dir ./extracted_mds --workers 1
            
            # ğŸ”§ ä¿®å¤ marker-pdf 1.10.1 è¾“å‡ºç›®å½•ç»“æ„é—®é¢˜
            # marker-pdf 1.10.1 å°† .md æ–‡ä»¶ç”Ÿæˆåœ¨å­ç›®å½•ä¸­ï¼Œéœ€è¦ç§»åˆ°é¡¶å±‚
            echo "ä¿®å¤ marker è¾“å‡ºç›®å½•ç»“æ„..."
            bash script/fix_marker_output.sh ./extracted_mds
            
            # ç»Ÿè®¡å¤„ç†ç»“æœï¼ˆä¿®å¤ååº”è¯¥èƒ½æ‰¾åˆ°æ–‡ä»¶äº†ï¼‰
            md_count=$(find ./extracted_mds -maxdepth 1 -name "*.md" -type f | wc -l)
            echo "âœ… æˆåŠŸæå–äº† $md_count ä¸ª Markdown æ–‡ä»¶"
            
            # éªŒè¯æ˜¯å¦æœ‰æ–‡ä»¶
            if [ $md_count -eq 0 ]; then
              echo "âŒ é”™è¯¯: æ²¡æœ‰ç”Ÿæˆ Markdown æ–‡ä»¶"
              exit 1
            fi
          else
            echo "è¯¥æ‰¹æ¬¡æ²¡æœ‰ PDF æ–‡ä»¶ï¼Œè·³è¿‡å¤„ç†"
          fi

      - name: ä¸Šä¼ å¤„ç†ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: extracted-${{ matrix.batch }}
          path: extracted_mds/
          retention-days: 1

      
      - name: AI æ‘˜è¦
        env:
          SUMMARY_API_KEY: ${{ secrets.SUMMARY_API_KEY }}
        run: |
          uv sync
          uv run python script/summarize.py ./extracted_mds/ --lang zh

      - name: ä¸Šä¼  AI æ‘˜è¦ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ai-summary-${{ matrix.batch }}
          path: ./extracted_mds/**/*.json

  merge_results:
    name: åˆå¹¶æ‰€æœ‰æ–‡ä»¶
    runs-on: ubuntu-latest
    needs: process_pdfs
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
        
      - name: ä¸‹è½½æ‰€æœ‰ artifact
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: åˆå¹¶ Markdown æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
          mkdir -p merged_mds
          
          # æ‰¾åˆ°æ‰€æœ‰ .md æ–‡ä»¶å¹¶å¤åˆ¶åˆ° merged_mds/
          find all_artifacts -name "*.md" -type f -exec cp {} merged_mds/ \;
          
          # æ£€æŸ¥åˆå¹¶çš„æ–‡ä»¶æ•°é‡
          total_md=$(find merged_mds -name "*.md" | wc -l)
          echo "æˆåŠŸåˆå¹¶äº† $total_md ä¸ª Markdown æ–‡ä»¶"

      - name: ä¸Šä¼ åˆå¹¶åçš„ Markdown æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: merged-markdowns
          path: merged_mds/
          retention-days: 7

      - name: åˆå¹¶ JSON æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
          mkdir -p merged_jsons
          
          # æ‰¾åˆ°æ‰€æœ‰ .json æ–‡ä»¶å¹¶å¤åˆ¶åˆ° merged_jsons/
          find all_artifacts -name "*.json" -type f -exec cp {} merged_jsons/ \;
          rm -rf merged_jsons/**/*_meta.json
          
          # æ£€æŸ¥åˆå¹¶çš„æ–‡ä»¶æ•°é‡
          total_json=$(find merged_jsons -name "*.json" | wc -l)
          echo "æˆåŠŸåˆå¹¶äº† $total_json ä¸ª JSON æ–‡ä»¶"

      - name: ä¸‹è½½é¢„æµ‹ç»“æœ
        uses: actions/download-artifact@v4
        with:
          name: predictions

      - name: æ›´æ–° json å…ƒæ•°æ®
        run: |
          uv sync
          uv run python script/update_metadata.py -j merged_jsons -p predictions.parquet

      - name: ä¸Šä¼ åˆå¹¶åçš„ JSON æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: merged-jsons
          path: merged_jsons/
          retention-days: 7

      - name: åˆå¹¶ JSON æ–‡ä»¶åˆ° Parquet
        run: |
          uv run python script/json2parquet.py merged_jsons main.parquet

      - name: ä¸Šä¼ åˆå¹¶åçš„ Parquet æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: merged-parquet
          path: main.parquet
          retention-days: 7
      
      - name: ä¸Šä¼  Parquet åˆ° Hugging Face
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          # ä¸Šä¼ åˆ° Hugging Face
          uv run python script/upload2hg.py main.parquet main.parquet lyk/PaperDigestDataBase

  trigger_build:
    name: è§¦å‘æ„å»ºWorkflow
    runs-on: ubuntu-latest
    needs: merge_results
    permissions: write-all
    steps:
      - name: è§¦å‘æ„å»ºWorkflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: build_page.yaml
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main